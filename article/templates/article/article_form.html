{% extends "./_base.html" %}
{% load bootstrap4 %}
{% block page_name %}記事作成{% endblock %}
{% block page_description %}見出しごとにブロックを追加してください。{% endblock %}
{% block content %}

    {{ form.certifications.errors }}
    <div class="row">
      <div class="col-xs-12">

        <div class="box box-info">
          <div class="box-header with-border">
            <h3 class="box-title">記事登録</h3>
          </div><!-- /.box-header -->
          <div>
            {% bootstrap_formset_errors formset %}
          </div>
          <form method="post" id="myform" class="form-horizontal">
            <div class="box-body">
                {% csrf_token %}
                {{ formset.management_form }}
                {% for field in form %}
                    <div class="form-group">
                        <label class="col-xs-2 control-label" for="{{ form.intro_title.id_for_label }}">{{ field.label_tag }}</label>
                        <div class="col-xs-10">
                            {{ field }}
                        </div>

                        {% if field.help_text %}
                            <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}

                        {% for error in field.errors %}
                            <small class="form-text text-danger">{{ error }}</small>
                        {% endfor %}
                    </div>
                {% endfor %}
                <table class="table table-striped">
                    <tbody class="articledetail">
                    {% for form in formset %}
                        <tr>
                            <td class="align-middle rownum col-xs-2">
                                <label class="control-label">見出しブロック</label>
                            </td>
                            <td>
                                {% bootstrap_field form.order_id show_label=true field_class="col-xs-10" %}
                                {% bootstrap_field form.block_title show_label=true field_class="col-xs-10" %}
                                {% bootstrap_field form.block_content show_label=true field_class="col-xs-10" %}
                                {% bootstrap_field form.DELETE show_label=true field_class="float-right col-xs-10" %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <a class="btn btn-outline-secondary add-articledetail col-12">行を追加</a>
            </div>
            <div class="box-footer">
                <button type="submit" class="btn btn-default">Cancel</button>
                {% if object %}
                    <a class="btn btn-outline-secondary command" href="{% url 'detail' article.pk %}">戻る</a>
                {% else %}
                    <a class="btn btn-outline-secondary command" href="{% url 'index' %}">戻る</a>
                {% endif %}
                <a class="btn btn-outline-secondary command save" href="#">登録</a>
            </div>
          </form>
        </div><!-- /.box -->
      </div>
    </div>
{% endblock %}

{% block bottom_script %}
    <script type="text/html" id="articledetail-template">
        <tr id="articledetail-__prefix__">
            <td class="align-middle rownum col-xs-2">
                <label class="control-label">見出しブロック</label>
            </td>
            <td>
                {% bootstrap_field formset.empty_form.order_id show_label=False field_class="col-xs-10" %}
                {% bootstrap_field formset.empty_form.block_title show_label=False field_class="col-xs-10" %}
                {% bootstrap_field formset.empty_form.block_content show_label=False field_class="col-xs-10" %}
                {% bootstrap_field formset.empty_form.DELETE show_label=False field_class="float-right col-xs-10" %}
            </td>
        </tr>
    </script>
    <script>
        //SimpleMDEを利用できるようにしている。
        document.addEventListener( 'DOMContentLoaded', function( event ) {
          var simplemde = new SimpleMDE({
            element: document.getElementById('id_intro_content'),
            autosave: {
              enabled: true,
              uniqueId: "markdownblogeditor",
              delay: 1000,
            },
            forceSync: true
          })
        });
        $(function () {
            $('.add-articledetail').click(function (e) {

                e.preventDefault();
                var count = parseInt($('#id_articledetail_set-TOTAL_FORMS').attr('value'), 10);
                var tmplMarkup = $('#articledetail-template').html();
                var compiledTmpl = tmplMarkup.replace(/__prefix__/g, count)
                console.log(compiledTmpl);
                $('tbody.articledetail').append(compiledTmpl);
                $('#id_articledetail_set-TOTAL_FORMS').attr('value', count + 1);
            });
        });
    </script>
{% endblock bottom_script %}